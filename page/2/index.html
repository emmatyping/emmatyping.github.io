<!DOCTYPE html>
<html lang="en">

<head>
    <title>emmatyping</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://emmatyping.dev/style.css">
    <link rel="stylesheet" href="https://emmatyping.dev/color/blue.css">

        <link rel="stylesheet" href="https://emmatyping.dev/color/background_dark.css">
    
    <link rel="stylesheet" href="https://emmatyping.dev/font-hack-subset.css">

    <link rel="me" href="https://hachyderm.io/@emmatyping">
</head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://emmatyping.dev" style="text-decoration: none;">
                    <div class="logo">
                      
                            Emma&#x27;s Blog
                        
                    </div>
                </a>
            </div>
        </div>

        
        
                <nav class="menu">
            <ul class="menu__inner">
                <li class="active"><a href="https://emmatyping.dev">Home</a></li>
            
                <li><a href="https://emmatyping.dev/about/me">About</a></li>
            
                <li><a href="https://emmatyping.dev/about/contact">Contact</a></li>
            
                <li><a href="https://github.com/emmatyping" target="_blank" rel="noopener noreferrer">Github</a></li>
            
                <li><a href="https://hachyderm.io/@emmatyping" target="_blank" rel="noopener noreferrer">Mastodon</a></li>
            
                <li><a href="https://bsky.app/profile/emmatyping.dev" target="_blank" rel="noopener noreferrer">BlueSky</a></li>
            </ul>
        </nav>
    
    
        
    </header>
    

    <div class="content">
        
        <div class="posts">
                <div class="post on-list">
                    
    <h1 class="post-title"><a href="https://emmatyping.dev/concurrent-sqlite/">Using multiprocessing and sqlite3 together</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2023-05-19
        </span>

    </div>

    

                    
        <div class="post-content">
            <blockquote>
<p>Note from the author: this is a pseudo TIL, but I hadn't seen it written down anywhere, hopefully someone finds it useful!
Jump to &quot;Solution&quot; below if you don't care about the background.</p>
</blockquote>
<h1 id="background">Background</h1>
<h3 id="generating-data">Generating Data</h3>
<p>I recently started working on a reinforcement learning project, and I needed to generate a lot of training data. The project involves quantum compilers, so the data I generate is quantum circuits. For those unfamiliar, quantum circuits are just sequences of unitary matrices laid out in a particular order. I chose to store the circuit as a sequence of unitary gate names. The output of the data generation is the unitaries (numpy arrays) that are the result of multiplying the matrices in the circuit together.</p>
<p>I ended up wanting to generate somewhere in the region of a few hundred billion matrices, each of them very small. I knew off the bat that this would require a fair bit of time, and I wanted to take advantage of the 32 core server I own. Since I was using Python to generate this data, I used the multiprocessing module. Sadly I cannot yet take advantage of <a href="https://martinheinz.dev/blog/97">Python multithreading coming in 3.12</a>.</p>
<h3 id="disk-space-woes">Disk Space Woes</h3>
<p>For saving the generated matrices, I started off by doing the simplest thing, just using plain-old <code>np.savetxt</code> to save the (pretty tiny) matrices to disk in each process after computing the product of the matrices in the quantum circuit. This... was problematic. I quickly ran into a disk out of space error. Normally this means I need to clear out space on whatever VM I am using, but there was one problem -- I still had hundreds of gigabytes of space left on disk! </p>
<p>I quickly deduced the error actually was caused by hitting the limit on entries in a directory, dang it <a href="https://cifs.com/">CIFS</a>! I briefly tried to make my own schema to split the unitaries into more directories to avoid this limit but I ended up hitting more file system limits. It was clear just writing files to disk wouldn't scale to the size of dataset I needed to generate.</p>
<h3 id="choosing-a-database">Choosing a Database</h3>
<p>Of course, dealing with so many small files, a database was the right solution to this problem. Why didn't I start with a database to begin with? Partially because I wanted to make it easy to load individual unitaries (<code>np.loadtxt</code> is an incredibly handy API). Also, I was just hacking this data generation script together.</p>
<p>I had one issue with switching to a database: I wanted something simple and lightweight, I didn't need anything fancy like postgres or the like. Sqlite is the obvious choice but sqlite does not by default support concurrent <em>writes</em>, which is exactly what I wanted to do!</p>
<h1 id="solution">Solution</h1>
<p>So how can one achieve concurrent writes in Python using sqlite3? Sqlite by default uses a rollback log to maintain consistency. You can change the configuration so that sqlite uses <a href="https://www.sqlite.org/wal.html">a <em>write-ahead</em> log (WAL) mode</a> as well, which allows for concurrent writes. You can enable WAL mode in Python by setting the <a href="https://www.sqlite.org/pragma.html#pragma_journal_mode">journal mode</a>:</p>
<pre data-lang="python3" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python3 "><code class="language-python3" data-lang="python3"><span># assume some Cursor object `cursor`
</span><span>cursor.execute(&#39;PRAGMA journal_mode = WAL&#39;)
</span></code></pre>
<p>However, I started getting exceptions part way through. Some processes calculating the unitaries were being told the database was locked, even though it should not be (these processes should be writing to the WAL, which I want to always be available). Therefore I also set <a href="https://www.sqlite.org/pragma.html#pragma_synchronous">the sqlite pragma <code>synchronous</code></a> to <code>OFF</code>, which means that the WAL does not synchronize before checkpoints. Note this is <strong>dangerous</strong> because theoretically your database could become corrupted if the process crashes or the server shuts down. This is acceptable to me because I can always regenerate the database and either of these are very unlikely to occur while I run these data generation tasks. This can be done in Python like so:</p>
<pre data-lang="python3" style="background-color:#1e1e1e;color:#dcdcdc;" class="language-python3 "><code class="language-python3" data-lang="python3"><span># assume some Cursor object `cursor`
</span><span>cursor.execute(&#39;PRAGMA synchronous = OFF&#39;)
</span></code></pre>
<p>In summary, by enabling the WAL and turning some sync'ing off, I was able to get multi-processed Python code to concurrently write to a sqlite database. This also gave a nice speed bump since sqlite is optimized for writing many small amounts of data to disk, a nice bonus!</p>

        </div>

                </div>
            
                <div class="post on-list">
                    
    <h1 class="post-title"><a href="https://emmatyping.dev/rust-tools-apt/">Rust CLI tools apt repo</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2022-11-26
        </span>

    </div>

    

                    
        <div class="post-content">
            <blockquote>
<p>tl;dr
Go to <a href="http://apt.cli.rs">http://apt.cli.rs</a> and follow the instructions to add the apt repo</p>
</blockquote>
<p>I guess its only fair to start my new blogging kick by catching up on a project I'd worked on several months ago which is pretty much &quot;done.&quot; I really like several Rust tools, such as <a href="https://github.com/BurntSushi/ripgrep"><code>ripgrep</code></a>, <a href="https://github.com/sharkdp/hyperfine"><code>hyperfine</code></a>, and <a href="https://github.com/sharkdp/fd"><code>fd</code></a>. I wanted an easy way to install them on Debian-based systems that may not have them in the official repos, so I needed to create my own apt repo. I was originally considering making a ppa, or private package archive, since I mainly use Ubuntu, but I decided I wanted these tools available on Debian as well, so my only option was an apt repo.</p>
<p>It turns out that apt repos are really simple, you just need to serve a directory with e.g. nginx. It took me a while to find a tool I liked using for making the apt repo, however. I started with trying <code>reprepro</code>, but I found it was more annoying to use than I wanted, so I ended up using <a href="https://www.aptly.info/"><code>aptly</code></a>, a newer apt repo management tool.</p>
<p>When setting up the repo, my criteria for inclusion were:</p>
<ul>
<li>the tool must be able to build <code>*.deb</code> packages. This is the package format for Debian/Ubuntu so definitely required</li>
<li>the tool must build those packages. I wanted to use the official/same binaries as those in the Github release</li>
<li>the binary packages must be statically musl-linked. Since various versions of Debian/Ubuntu use different versions of glibc, you can get version compatibility errors if you don't statically link. Statically linking to musl is <em>much</em> easier than glibc, so this seemed to be the best route to avoid compatibility errors.</li>
</ul>
<p>With these criteria in hand, I then set up the apt repo with the CLI tools that fit and wrote a script to try updating all of the packages, pulling from the official Github releases. I have subscribed to releases on Github from all the repos that are currently included in the apt repo so all I have to do is run the script when a new release comes out from one of the repos. I may end up setting up a cronjob that runs this update script, but I'm weighing whether it is worth any potential risks...</p>
<p>Anyway, if you are interested in using this apt repo, head on over to <a href="http://apt.cli.rs">https://apt.cli.rs</a>, I've written up the commands you need to get started using the apt repo.</p>
<p>If you have suggestions for Rust CLI tools that should be included, please <a href="https://github.com/emmatyping/apt.cli.rs/issues/new">open an issue on the github</a>! If a package doesn't build musl-linked Debian packages, consider opening an issue on that project to add it. However, please <em>do not</em> spam maintainers asking for these packages to be built. I unfortunately do not have time to contribute to the packaging of every great Rust CLI tool, but I can add them to the apt repo if they are packaged already!</p>
<p>Anyway, hopefully someone else finds it useful!</p>

        </div>

                </div>
            <div class="pagination">
                <div class="pagination__buttons">
                    <span class="button previous">
                        <a href="https://emmatyping.dev/">
                            <span class="button__icon">←</span>&nbsp;
                            <span class="button__text">Newer posts</span>
                        </a>
                    </span>
                
                    <span class="button next">
                        <a href="https://emmatyping.dev/page/3/">
                            <span class="button__text">Older posts</span>&nbsp;
                            <span class="button__icon">→</span>
                        </a>
                    </span>
                </div>
            </div>
        </div>
        
    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright">
                        <span>© 
    2025
 Emma Harper Smith</span>
                    <span class="copyright-theme">
                        <span class="copyright-theme-sep">:: </span>
                        Theme: <a href="https://github.com/pawroman/zola-theme-terminimal/">Terminimal</a> by pawroman
                    </span>
                </div>
            </div>
    </footer>
    

</div>
</body>

</html>
